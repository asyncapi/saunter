<?xml version="1.0" encoding="utf-8" standalone="no"?>
<Project>

  <Target Name="PostBuild" AfterTargets="PostBuildEvent" Condition=" '$(AsyncAPIGenerateDocumentsOnBuild)' == 'true' ">
    <PropertyGroup>
      <AsyncAPIBuildToolBuildDir>$([System.IO.Path]::GetDirectoryName($(MSBuildThisFileDirectory)))</AsyncAPIBuildToolBuildDir>
      <AsyncAPIBuildToolRoot>$([System.IO.Path]::GetDirectoryName($(AsyncAPIBuildToolBuildDir)))</AsyncAPIBuildToolRoot>
      <LocalToolConfigFile>./.config/dotnet-tools.json</LocalToolConfigFile>
      <LocalToolConfigFillFullPath>$([System.IO.Path]::GetFullPath($([System.IO.Path]::Combine($(AsyncAPIBuildToolRoot), $(LocalToolConfigFile)))))</LocalToolConfigFillFullPath>
    </PropertyGroup>

    <Message Text="AsyncAPI.Build; AsyncAPIDocumentFormats: $(AsyncAPIDocumentFormats)" />
    <Message Text="AsyncAPI.Build; AsyncAPIDocumentOutputPath: $(AsyncAPIDocumentOutputPath)" />
    <Message Text="AsyncAPI.Build; AsyncAPIDocumentNames: $(AsyncAPIDocumentNames)" />
    <Message Text="AsyncAPI.Build; AsyncAPIDocumentFilename: $(AsyncAPIDocumentFilename)" />
    <Message Text="AsyncAPI.Build; AsyncAPIDocumentEnvVars: $(AsyncAPIDocumentEnvVars)" />
    <Message Text="AsyncAPI.Build; AsyncAPIBuildToolBuildDir: $(AsyncAPIBuildToolBuildDir)" />
    <Message Text="AsyncAPI.Build; AsyncAPIBuildToolRoot: $(AsyncAPIBuildToolRoot)" />
    <Message Text="AsyncAPI.Build; MSBuildThisFile: $(MSBuildThisFile)" />
    <Message Text="AsyncAPI.Build; MSBuildThisFileDirectory: $(MSBuildThisFileDirectory)" />
    <Message Text="AsyncAPI.Build; MSBuildProjectFullPath: $(MSBuildProjectFullPath)" />
    <Message Text="AsyncAPI.Build; MSBuildProjectDirectory: $(MSBuildProjectDirectory)" />
    <Message Text="AsyncAPI.Build; LocalToolConfigFile: $(LocalToolConfigFile) --> $(LocalToolConfigFillFullPath)" />
    
    <Exec Command="dotnet new tool-manifest" 
          Condition=" '$([System.IO.File]::Exists($(LocalToolConfigFillFullPath)))' == 'false' "
          WorkingDirectory="$(AsyncAPIBuildToolRoot)" />
    <Exec Command="dotnet tool install --local AsyncAPI.Saunter.Generator.Cli"
          WorkingDirectory="$(AsyncAPIBuildToolRoot)" />

    <Exec Command="dotnet tool run dotnet-asyncapi tofile --output &quot;$(MSBuildProjectDirectory)/$(AsyncAPIDocumentOutputPath)&quot; --format &quot;$(AsyncAPIDocumentFormats)&quot; --doc &quot;$(AsyncAPIDocumentNames)&quot; --filename &quot;$(AsyncAPIDocumentFilename)&quot; --env &quot;$(AsyncAPIDocumentEnvVars)&quot; &quot;$(MSBuildProjectDirectory)/$(OutputPath)/$(AssemblyTitle).dll&quot;"
          WorkingDirectory="$(AsyncAPIBuildToolRoot)" />
  </Target>

</Project>